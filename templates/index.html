{% extends "layout.html" %}
{% block title %}Find What's Lost - CampusFind{% endblock %}

{% block content %}
<div class="text-center py-16 md:py-20 bg-gray-800/50 rounded-lg shadow-2xl mb-8 border border-gray-700 bg-gradient-to-br from-gray-800 to-gray-900">
    <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-white" style="text-shadow: 0 2px 10px rgba(0, 255, 255, 0.2);">Lost Something? Found Something?</h1>
    <p class="mt-4 text-lg text-gray-400 max-w-2xl mx-auto">The central hub for all lost and found items on campus. Start by searching or filtering below.</p>
</div>

<!-- Announcement Section -->
{% if announcement %}
<div class="bg-teal-900/50 border border-teal-500/30 text-teal-200 px-4 py-3 rounded-lg relative mb-8" role="alert">
    <div class="flex justify-between items-center">
        <div>
            <strong class="font-bold"><i class="fa fa-bullhorn mr-2"></i>Announcement:</strong>
            <span class="block sm:inline ml-2">{{ announcement.content }}</span>
        </div>
        <a href="{{ url_for('all_announcements') }}" class="text-xs text-teal-300 hover:underline whitespace-nowrap">View All &rarr;</a>
    </div>
</div>
{% endif %}

<!-- Filters and Items Section -->
<div class="px-4">
    <!-- Filter Controls -->
    <div class="bg-gray-800 p-4 rounded-lg shadow-xl border border-gray-700 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="md:col-span-2 lg:col-span-4">
                <label for="live-search-input" class="flex items-center text-sm font-medium text-gray-400 mb-2"><i class="fa fa-search w-5 mr-2"></i>Search by Keyword</label>
                <input type="search" id="live-search-input" name="q" placeholder="Start typing to filter items in real-time..." class="w-full rounded-lg bg-gray-700 border-gray-600 text-white p-3 focus:ring-2 focus:ring-teal-500 focus:border-transparent">
            </div>
            <div>
                <label for="category-filter" class="flex items-center text-sm font-medium text-gray-400 mb-2"><i class="fa fa-folder-open w-5 mr-2"></i>Category</label>
                <select id="category-filter" class="w-full rounded-lg bg-gray-700 border-gray-600 text-white p-3 focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    <option value="all">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="location-filter" class="flex items-center text-sm font-medium text-gray-400 mb-2"><i class="fa fa-map-marker-alt w-5 mr-2"></i>Location</label>
                <select id="location-filter" class="w-full rounded-lg bg-gray-700 border-gray-600 text-white p-3 focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    <option value="all">All Locations</option>
                    {% for loc in locations %}
                    <option value="{{ loc.id }}">{{ loc.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2"><i class="fa fa-tags w-5 mr-2 inline"></i>Item Type</label>
                <div class="flex space-x-2 bg-gray-900/50 p-1 rounded-lg">
                    <button class="filter-btn active w-full" data-filter="all">All</button>
                    <button class="filter-btn w-full" data-filter="lost">Lost</button>
                    <button class="filter-btn w-full" data-filter="found">Found</button>
                </div>
            </div>
            <div>
                <label for="sort-filter" class="flex items-center text-sm font-medium text-gray-400 mb-2"><i class="fa fa-sort-amount-down w-5 mr-2"></i>Sort By</label>
                <select id="sort-filter" class="w-full rounded-lg bg-gray-700 border-gray-600 text-white p-3 focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="title-asc">Title (A-Z)</option>
                    <option value="title-desc">Title (Z-A)</option>
                </select>
            </div>
        </div>
    </div>
    
    <h2 class="text-2xl font-bold text-white mb-6">Recently Reported Items</h2>
    
    {% if items %}
    <div id="items-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for item in items %}
        <div class="item-card bg-gray-800 border border-gray-700 rounded-lg shadow-lg overflow-hidden hover:border-teal-500 transition-all duration-300 flex flex-col transform hover:-translate-y-1" 
             data-type="{{ item.item_type }}" 
             data-category="{{ item.category_id }}" 
             data-location="{{ item.location_id }}"
             data-date="{{ item.reported_at.isoformat() }}">
            <a href="{{ url_for('item_details', item_id=item.id) }}" class="block relative">
                <img loading="lazy" src="{{ item.main_image or 'https://placehold.co/600x400/1F2937/4B5563?text=No+Image' }}" alt="{{ item.title }}" class="w-full h-48 object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
            </a>
            <div class="p-4 flex-grow flex flex-col">
                <div class="flex-grow">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="searchable-title text-lg font-semibold text-white leading-tight">{{ item.title }}</h3>
                        <span class="text-xs font-medium px-2.5 py-1 rounded-full whitespace-nowrap
                            {% if item.item_type == 'lost' %} bg-red-900/50 text-red-300 border border-red-500/30
                            {% else %} bg-green-900/50 text-green-300 border border-green-500/30 {% endif %}">
                            {{ item.item_type|capitalize }}
                        </span>
                    </div>
                    <p class="searchable-desc text-gray-400 text-sm mb-4 h-12 overflow-hidden">{{ item.description }}</p>
                    
                    <div class="space-y-2 text-sm text-gray-400">
                        <div class="flex items-center">
                            <i class="fa fa-folder-open w-5 text-gray-500 mr-2"></i>
                            <span>{{ item.category_name }}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fa fa-map-marker-alt w-5 text-gray-500 mr-2"></i>
                            <span>{{ item.location_name }}</span>
                        </div>
                          <div class="flex items-center">
                            <i class="fa fa-clock w-5 text-gray-500 mr-2"></i>
                            <span>{{ item.reported_at.strftime('%d %b %Y') }}</span>
                        </div>
                    </div>
                </div>
                <div class="pt-4 mt-4 border-t border-gray-700">
                    <a href="{{ url_for('item_details', item_id=item.id) }}" class="w-full block text-center font-semibold text-teal-400 hover:text-teal-300">View Details &rarr;</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="pagination-container" class="flex justify-center items-center mt-10 space-x-2"></div>

    <div id="no-results-message" class="text-center py-16 bg-gray-800 rounded-lg shadow-md border border-gray-700 hidden">
        <i class="fa fa-search-minus text-5xl text-gray-600 mb-4"></i>
        <h3 class="text-xl font-semibold text-white">No items match your filter.</h3>
        <p class="text-gray-500 mt-2">Try a different search term or change the filter.</p>
        <button id="clear-filters-btn" class="mt-4 bg-teal-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-teal-700">Clear All Filters</button>
    </div>
    {% else %}
    <div class="text-center py-16 bg-gray-800 rounded-lg shadow-md border border-gray-700">
        <i class="fa fa-box-open text-5xl text-gray-600 mb-4"></i>
        <h3 class="text-xl font-semibold text-white">No items found.</h3>
        <p class="text-gray-500 mt-2">There are no reported items yet. Be the first to report one!</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<style>
    .filter-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; color: #9ca3af; transition: all 0.2s ease-in-out; }
    .filter-btn:hover { background-color: #374151; color: #ffffff; }
    .filter-btn.active { background-color: #14b8a6; color: #ffffff; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .pagination-btn { padding: 0.6rem 1.1rem; border-radius: 0.5rem; font-weight: 600; color: #9ca3af; transition: all 0.2s ease-in-out; background-color: #374151; }
    .pagination-btn:hover { background-color: #4b5563; }
    .pagination-btn.active { background-color: #14b8a6; color: #ffffff; }
    .pagination-btn:disabled { background-color: #1f2937; color: #4b5563; cursor: not-allowed; }
    
    #items-container { transition: opacity 0.2s ease-in-out; }
    #items-container.is-filtering { opacity: 0; }
</style>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('live-search-input');
    const categoryFilter = document.getElementById('category-filter');
    const locationFilter = document.getElementById('location-filter');
    const sortFilter = document.getElementById('sort-filter');
    const typeFilterButtons = document.querySelectorAll('.filter-btn');
    const itemsContainer = document.getElementById('items-container');
    const noResultsMessage = document.getElementById('no-results-message');
    const paginationContainer = document.getElementById('pagination-container');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');

    if (!itemsContainer) return;

    const allItemCards = Array.from(itemsContainer.getElementsByClassName('item-card'));
    let filteredItems = [...allItemCards];
    let currentPage = 1;
    const ITEMS_PER_PAGE = 8;

    function applyFiltersAndSort() {
        itemsContainer.classList.add('is-filtering');

        setTimeout(() => {
            const searchText = searchInput.value.toLowerCase().trim();
            const selectedCategory = categoryFilter.value;
            const selectedLocation = locationFilter.value;
            const activeTypeFilter = document.querySelector('.filter-btn.active').dataset.filter;

            filteredItems = allItemCards.filter(card => {
                const title = card.querySelector('.searchable-title').textContent.toLowerCase();
                const description = card.querySelector('.searchable-desc').textContent.toLowerCase();
                const type = card.dataset.type;
                const category = card.dataset.category;
                const location = card.dataset.location;

                const textMatch = (title.includes(searchText) || description.includes(searchText));
                const typeMatch = (activeTypeFilter === 'all' || type === activeTypeFilter);
                const categoryMatch = (selectedCategory === 'all' || category === selectedCategory);
                const locationMatch = (selectedLocation === 'all' || location === selectedLocation);

                return textMatch && typeMatch && categoryMatch && locationMatch;
            });

            const sortValue = sortFilter.value;
            filteredItems.sort((a, b) => {
                if (sortValue === 'newest') return new Date(b.dataset.date) - new Date(a.dataset.date);
                if (sortValue === 'oldest') return new Date(a.dataset.date) - new Date(b.dataset.date);
                const titleA = a.querySelector('.searchable-title').textContent.toLowerCase();
                const titleB = b.querySelector('.searchable-title').textContent.toLowerCase();
                if (sortValue === 'title-asc') return titleA.localeCompare(titleB);
                if (sortValue === 'title-desc') return titleB.localeCompare(titleA);
                return 0;
            });

            currentPage = 1;
            renderPage();
            renderPagination();
            
            itemsContainer.classList.remove('is-filtering');
        }, 200);
    }

    function renderPage() {
        itemsContainer.innerHTML = ''; 
        noResultsMessage.classList.toggle('hidden', filteredItems.length > 0);

        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const pageItems = filteredItems.slice(startIndex, endIndex);

        pageItems.forEach(card => itemsContainer.appendChild(card));
    }

    function renderPagination() {
        paginationContainer.innerHTML = '';
        const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);

        if (totalPages <= 1) return;

        const createPageButton = (page) => {
            const button = document.createElement('button');
            button.className = 'pagination-btn';
            button.textContent = page;
            if (page === currentPage) button.classList.add('active');
            button.addEventListener('click', () => goToPage(page));
            paginationContainer.appendChild(button);
        };

        const prevButton = document.createElement('button');
        prevButton.innerHTML = '&laquo;';
        prevButton.className = 'pagination-btn';
        prevButton.disabled = currentPage === 1;
        prevButton.addEventListener('click', () => goToPage(currentPage - 1));
        paginationContainer.appendChild(prevButton);

        for (let i = 1; i <= totalPages; i++) {
            createPageButton(i);
        }

        const nextButton = document.createElement('button');
        nextButton.innerHTML = '&raquo;';
        nextButton.className = 'pagination-btn';
        nextButton.disabled = currentPage === totalPages;
        nextButton.addEventListener('click', () => goToPage(currentPage + 1));
        paginationContainer.appendChild(nextButton);
    }

    function goToPage(pageNumber) {
        if (pageNumber < 1 || pageNumber > Math.ceil(filteredItems.length / ITEMS_PER_PAGE)) return;
        
        itemsContainer.classList.add('is-filtering');
        setTimeout(() => {
            currentPage = pageNumber;
            renderPage();
            renderPagination();
            itemsContainer.classList.remove('is-filtering');
        }, 200);
    }

    function clearAllFilters() {
        searchInput.value = '';
        categoryFilter.value = 'all';
        locationFilter.value = 'all';
        sortFilter.value = 'newest';
        typeFilterButtons.forEach(btn => btn.classList.remove('active'));
        document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
        applyFiltersAndSort();
    }

    renderPage();
    renderPagination();

    searchInput.addEventListener('input', applyFiltersAndSort);
    categoryFilter.addEventListener('change', applyFiltersAndSort);
    locationFilter.addEventListener('change', applyFiltersAndSort);
    sortFilter.addEventListener('change', applyFiltersAndSort);
    typeFilterButtons.forEach(button => {
        button.addEventListener('click', function() {
            typeFilterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            applyFiltersAndSort();
        });
    });
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearAllFilters);
    }
});
</script>
{% endblock %}
